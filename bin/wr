#!/usr/bin/env hy

(import prettytable [PrettyTable])
(import argparse [ArgumentParser])
(import sys)
(import re)
(require hyrule [->>])

(setv builtin-filter filter)

(defn try-parse-number [s]
    (try
        (if (in "." s) 
            (float s) 
            (int s))
        (except [ValueError]
            s))
)

(defn pad-arr [arr n val]
    (if (< (len arr) n)
        (+ arr (* [val] (- n (len arr))))
        arr))
        
(defn empty? [arr]
    (= (len arr) 0))

(defn print-table [table]
    (if (empty? table) None
    (let [x (PrettyTable)
        max-len (max (map (fn [row] (len row)) table))
    ] 
        (setv x.field_names (range max-len)) 
        (for [row table]
            (.add_row x (pad-arr row max-len ""))
        )
        (print x)))
)

(defn list? [x]
    (= (type x) list))
    
(defn m-get [col key]
    (if (list? col)
    (get col (int key))
    (.get col key)))

(defn construct-query [in]
    (->> (+ "(" in " table)")
        (re.sub r"it\.(\w+)" "(m-get it \"\\1\")")))

(defn eval-query [query table]
    (defmacro filter [func iter]
        `(builtin-filter (fn [it] ~func) ~iter))
        
    (list (hy.eval (hy.read (construct-query query)) :macros (local-macros)))
)

(defn main [] 
    (let [parser (ArgumentParser)]
        (.add_argument parser "query" :nargs "?")
        (setv args (.parse_args parser))
        (setv table [])
        (for [val (enumerate sys.stdin)] 
            (.append table (+ [(get val 0)]
            (list (map try-parse-number (.split (get val 1))))
                                )))
        (if args.query 
            (print-table (eval-query args.query table))
            (print-table table))
    )
)

(main)
